<!DOCTYPE html>
<html>
<head>
    <title>Consulta de Cliente</title>
    <script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <link rel="stylesheet" type="text/css" href="../static/styles.css"> <!-- Enlaza el archivo CSS externo -->
</head>
<body>
    
    <h1>Consulta de Cliente</h1>
    <form id="ClienteRequestForm">
        <label for="client_id">ID del cliente:</label>
        <input type="text" id="client_id" name="client_id" required>
        <br>
        <button type="button" onclick="consultarCliente()">Consultar</button>
    </form>
    <br>
    <div id="existe_cliente" class="hidden">        
        <h2>Nombre cliente: <span id="nombre_cliente"></span></h2>
    </div>           
    <div id="consultar_cliente" class="hidden">        
        <p>Preferencias cliente:<br> <span id="preferencias_cliente"></span></p>
    </div>    

    <div id="nuevo_cliente" class="hidden">
        <form id="ClienteRequestForm">
            <label >Registrar Nuevo cliente</label>        
            <label >Nombre:</label>        
            <input type="text" id="nuevo_nombre_cliente" name="nuevo_nombre_cliente">
            <label >Preferencias:</label>        
            <input type="text" id="registro_preferencia" name="registro_preferencia">
            <br>
            <button type="button" id="formulario_nueo_cliente" onclick="RegistraCliente()">Registrar</button>                
            <button type="button" id="limpiar_nueva_preferencia">Limpiar</button>
        </form>
    </div>   

    <div id="nuevas_preferencias" class="hidden">
        <h3>Registrar Nuevo Pedido:</h3>        
        <input type="text" id="nueva_preferencia" name="nueva_preferencia">
        <br>
        <button type="button" id="formulario_nuevas_preferencias" onclick="registraPreferencia()">Registrar</button>
        <button type="button" id="limpiar_nueva_preferencia2">Limpiar</button>
    </div>
    
    <p id="salida_registro2" class="hidden">Registro:<span></span></p>
    <p id="actualizarModelo" style="cursor: pointer; text-decoration: underline; color: blue; font-size: 10px; "  onclick="pedirClaveYActualizarModelo()">Actualizar Modelo</p>


    <script>
        document.addEventListener("DOMContentLoaded", function() {            
            document.getElementById("limpiar_nueva_preferencia2").addEventListener("click", function() {
                document.getElementById("nueva_preferencia").value = "";
            });
            document.getElementById("limpiar_nueva_preferencia").addEventListener("click", function() {                
                document.getElementById("nuevo_nombre_cliente").value = "";
                document.getElementById("registro_preferencia").value = "";
            });
        });

        function consultarCliente() {
            var client_id = $("#client_id").val();

            fetch('/existe_cliente/', {
                method: 'POST',
                headers: {'Content-Type': 'application/json'},
                body: JSON.stringify({ client_id: client_id })
            })
            .then(response => response.json())
            .then(data => {
                if (data.nombre_cliente) {
                    $("#existe_cliente").removeClass("hidden"); // Mostrar el nombre del cliente
                    $("#salida_registro2").addClass("hidden");                                        
                    $("#nombre_cliente").text(data.nombre_cliente);     
                    $("#nuevo_cliente").addClass("hidden");                     
                    cargarPreferencias(client_id)
                    
                } else {
                    $("#nuevo_cliente").removeClass("hidden");
                    //$("#existe_cliente").text("No existe el cliente, registrar");
                    $("#existe_cliente").addClass("hidden"); // Ocultar el nombre del cliente
                    $("#consultar_cliente").addClass("hidden"); // Ocultar las preferencias del cliente
                    $("#nuevas_preferencias").addClass("hidden"); // Ocultar nuevs prefere                    
                    $("#preferencias_cliente").text(""); // Limpiar el contenido de las preferencias
                }
            })
            .catch(error => {
                alert("Ocurrió un error al consultar al cliente.");
            });
        }

        function cargarPreferencias(client_id){
            fetch('/consultar_cliente/', {
                    method: 'POST',
                    headers: {'Content-Type': 'application/json'},
                    body: JSON.stringify({ client_id: client_id })
            })
            .then(response => response.json())
            .then(response => {
                var resultHtml = '<div class="table-container"><table>';
                resultHtml += '<tr><th>ITEM</th><th>Cantidad</th></tr>'; // Encabezados de la tabla
                response.forEach(function(item) {
                    resultHtml += '<tr>';
                    resultHtml += '<td>' + item.item + '</td>';
                    resultHtml += '<td>' + item.cantidad + '</td>';
                    resultHtml += '</tr>';
                });
                resultHtml += '</table></div>';
                $("#preferencias_cliente").html(resultHtml);
                $("#consultar_cliente").removeClass("hidden"); // Mostrar las preferencias del cliente
                $("#nuevas_preferencias").removeClass("hidden");  
                $("#nueva_preferencia").text("");                          
                
            })

            .catch(error => {
                $("#nuevo_cliente").addClass("hidden"); // Ocultar el nombre del cliente
                $("#consultar_cliente").addClass("hidden"); // Ocultar las preferencias del cliente
                $("#nuevas_preferencias").addClass("hidden"); // Ocultar nuevs prefere                    
                $("#preferencias_cliente").text(""); // Limpiar el contenido de las preferencias
                alert("Ocurrió un error al consultar las preferencias del cliente.");
            });
        }

        function cargarPreferencias2(client_id) {
            fetch('/consultar_cliente/', {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({ client_id: client_id })
            })
            .then(response => response.json())
            .then(response => {
                const labels = response.map(item => item.item);
                const data = response.map(item => item.cantidad);
                const config = {
                    type: 'horizontalBar',
                    data: {
                        labels: labels,
                        datasets: [{
                            label: 'Cantidad',
                            data: data,
                            backgroundColor: 'rgba(75, 192, 192, 0.2)',
                            borderColor: 'rgba(75, 192, 192, 1)',
                            borderWidth: 1
                        }]
                    },
                    options: {
                        scales: {
                            x: {
                                beginAtZero: true
                            }
                        }
                    }
                };

                const canvas = document.createElement('canvas');
                canvas.id = 'grafico-preferencias';

                const preferenciasCliente = document.getElementById('preferencias_cliente');
                preferenciasCliente.innerHTML = '';
                preferenciasCliente.appendChild(canvas);

                new Chart(canvas.getContext('2d'), config);

                // Otras operaciones después de mostrar el gráfico (si es necesario)
                $("#consultar_cliente").removeClass("hidden");
                $("#nuevas_preferencias").removeClass("hidden");
                $("#nueva_preferencia").text("");
            })
            .catch(error => {
                alert("Ocurrió un error al consultar las preferencias del cliente.");
            });
        }

        function registraPreferencia() {
            var client_id = $("#client_id").val();
            var nueva_preferencia = $("#nueva_preferencia").val();
            document.getElementById("nueva_preferencia").textContent = "";

            fetch('/registra_preferencia/', {
                method: 'POST',
                headers: {'Content-Type': 'application/json'},
                body: JSON.stringify({ client_id: client_id, preferencia: nueva_preferencia })
            })
            .then(response => response.json())
            .then(data => {
                if (data.salida) {
                    $("#salida_registro2").removeClass("hidden");                    
                    $("#existe_cliente").addClass("hidden"); // Ocultar el nombre del cliente
                    $("#consultar_cliente").addClass("hidden"); // Ocultar las preferencias del cliente
                    $("#nuevas_preferencias").addClass("hidden"); // Ocultar nuevs prefere                    
                    $("#preferencias_cliente").text(""); // Limpiar el contenido de las preferencias
                    $("#nueva_preferencia").text("");   
                    $("#salida_registro2").text(data.salida);     
                    $("#nuevo_cliente").addClass("hidden");               
                } else {
                    $("#salida_registro2").addClass("hidden");
                    $("#nuevo_cliente").addClass("hidden");
                }
            })
            .catch(error => {
                alert("Ocurrió un error al registrar la preferencia.");
            });
        }


        function RegistraCliente() {
            var client_id = $("#client_id").val();
            var nombre_cliente = $("#nuevo_nombre_cliente").val();            
            var preferencias_cliente = $("#registro_preferencia").val();

            fetch('/registra_cliente/', {
                method: 'POST',
                headers: {'Content-Type': 'application/json'},
                body: JSON.stringify({ client_id: client_id,nombre_cliente: nombre_cliente, preferencias_cliente: preferencias_cliente })
            })
            .then(response => response.json())
            .then(data => {
                if (data.salida) {
                    $("#salida_registro2").removeClass("hidden");                    
                    $("#existe_cliente").addClass("hidden"); // Ocultar el nombre del cliente
                    $("#consultar_cliente").addClass("hidden"); // Ocultar las preferencias del cliente
                    $("#nuevas_preferencias").addClass("hidden"); // Ocultar nuevs prefere                    
                    $("#preferencias_cliente").text(""); // Limpiar el contenido de las preferencias
                    $("#nueva_preferencia").text("");   
                    $("#salida_registro2").text(data.salida);     
                    $("#nuevo_cliente").addClass("hidden");               
                } else {
                    $("#salida_registro2").addClass("hidden");
                    $("#nuevo_cliente").addClass("hidden");
                }
            })
            .catch(error => {
                alert("Ocurrió un error al registrar la preferencia.");
            });
        }

        function pedirClaveYActualizarModelo() {
            const claveIngresada = prompt("Por favor, ingresa la clave:");
            if (claveIngresada === "12345") {
                alert("Modelo actualizado con éxito");
            } else {
                alert("Clave incorrecta. No tienes permiso para actualizar el modelo.");
            }
        }


    </script>
</body>
</html>
